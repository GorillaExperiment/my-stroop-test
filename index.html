<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤çŸ¥èƒ½åŠ›è¯„ä¼°ç³»ç»Ÿ - Stroop Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --secondary-text: #64748b;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: var(--card); width: 90%; max-width: 600px; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); text-align: center; }
        
        /* è¡¨å•ä¸æŒ‰é’®æ ·å¼ */
        .input-group { text-align: left; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 0.8rem 2rem; border-radius: 0.6rem; font-weight: 600; cursor: pointer; transition: all 0.2s; width: 100%; font-size: 1rem; }
        button:hover { background: #1d4ed8; transform: translateY(-1px); }
        
        /* æ¸¸æˆåŒºåŸŸ */
        #word { font-size: 4rem; font-weight: 800; margin: 2rem 0; min-height: 5rem; display: flex; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .color-btn { color: white; padding: 1.2rem; border-radius: 0.8rem; font-size: 1.1rem; }
        
        /* æ ‡ç­¾ */
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.8rem; font-weight: bold; margin-bottom: 1rem; }
        .practice-badge { background: #fef3c7; color: #92400e; }
        .formal-badge { background: #dcfce7; color: #166534; }

        .hidden { display: none; }

        /* æŠ¥å‘ŠåŒºåŸŸ */
        #report-area { text-align: left; }
        #report-area h3 { margin-top: 2rem; color: var(--text); }
        #report-area p { line-height: 1.6; color: var(--secondary-text); }
        #chart-container { position: relative; width: 100%; height: 300px; margin-top: 1.5rem; } /* ç¡®ä¿å›¾è¡¨æœ‰é«˜åº¦ */
        .stat-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e2e8f0; }
        .stat-label { font-weight: 600; }
        .stat-value { color: var(--primary); font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div id="step-info">
        <h2 style="margin-top:0">è®¤çŸ¥èƒ½åŠ›è¯„ä¼°ç³»ç»Ÿ</h2>
        <p style="color:var(--secondary-text)">é€šè¿‡ç»å…¸çš„ Stroop ä»»åŠ¡ï¼Œè¯„ä¼°æ‚¨çš„ä¸“æ³¨åŠ›ä¸æŠ—å¹²æ‰°èƒ½åŠ›ã€‚</p>
        <div class="input-group">
            <label for="subject-gender">æ€§åˆ«</label>
            <select id="subject-gender">
                <option value="male">ç”·</option>
                <option value="female">å¥³</option>
                <option value="other">å…¶ä»–</option>
            </select>
        </div>
        <div class="input-group">
            <label for="subject-age">å¹´é¾„</label>
            <input type="number" id="subject-age" placeholder="è¯·è¾“å…¥æ‚¨çš„å¹´é¾„" min="6" max="99">
        </div>
        <button onclick="toPractice()">å¼€å§‹è¯„ä¼°</button>
    </div>

    <div id="step-test" class="hidden">
        <div id="phase-indicator"></div>
        <div id="progress" style="font-size: 0.9rem; color: var(--secondary-text);">è¿›åº¦: 0 / 0</div>
        <div id="word"></div>
        <div class="grid">
            <button class="color-btn" style="background:#ef4444" onclick="handleInput('red')">çº¢</button>
            <button class="color-btn" style="background:#3b82f6" onclick="handleInput('blue')">è“</button>
            <button class="color-btn" style="background:#22c55e" onclick="handleInput('green')">ç»¿</button>
            <button class="color-btn" style="background:#eab308" onclick="handleInput('yellow')">é»„</button>
        </div>
    </div>

    <div id="step-finish" class="hidden">
        <h2 style="color:#166534">è¯„ä¼°æŠ¥å‘Š</h2>
        <div id="report-area">
            <h3>æ‚¨çš„è¡¨ç°æ¦‚è§ˆ</h3>
            <div class="stat-item">
                <span class="stat-label">å¹³å‡ååº”æ—¶é—´ (RT)</span>
                <span class="stat-value" id="avg-rt"></span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Stroop å¹²æ‰°å€¼ (è¶Šä½è¶Šå¥½)</span>
                <span class="stat-value" id="stroop-interference"></span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æ•´ä½“æ­£ç¡®ç‡</span>
                <span class="stat-value" id="accuracy"></span>
            </div>

            <h3>ååº”æ—¶åˆ†å¸ƒ</h3>
            <div id="chart-container">
                <canvas id="rtChart"></canvas>
            </div>
            
            <h3>ä¸“ä¸šè§£è¯»</h3>
            <p id="interpretation"></p>

            <button style="margin-top:2rem; background:#27ae60" onclick="exportData()">ğŸ’¾ ä¸‹è½½åŸå§‹æ•°æ® (CSV)</button>
        </div>
    </div>
</div>

<script>
    const config = { practice: 5, formal: 30 }; // ç»ƒä¹ 5æ¬¡ï¼Œæ­£å¼30æ¬¡
    const colors = ['red', 'blue', 'green', 'yellow'];
    const names = {'red':'çº¢', 'blue':'è“', 'green':'ç»¿', 'yellow':'é»„'};
    
    let state = {
        phase: 'practice', // practice æˆ– formal
        current: 0,
        results: [],
        subject: {},
        startTime: 0,
        currentTrialData: {} // å­˜å‚¨å½“å‰è½®æ¬¡çš„åŸå§‹æ•°æ®
    };

    function toPractice() {
        const age = document.getElementById('subject-age').value;
        if(!age || age < 6 || age > 99) {
            alert("è¯·å¡«å†™æœ‰æ•ˆçš„å¹´é¾„ (6-99å²)");
            return;
        }
        
        state.subject = {
            gender: document.getElementById('subject-gender').value,
            age: age,
            timestamp: new Date().toISOString()
        };
        
        document.getElementById('step-info').classList.add('hidden');
        document.getElementById('step-test').classList.remove('hidden');
        startPhase('practice');
    }

    function startPhase(phase) {
        state.phase = phase;
        state.current = 0;
        const indicator = document.getElementById('phase-indicator');
        indicator.innerHTML = phase === 'practice' 
            ? '<span class="badge practice-badge">ç»ƒä¹ æ¨¡å¼ (ä¸è®¡åˆ†)</span>' 
            : '<span class="badge formal-badge">æ­£å¼è¯„ä¼° (æ•°æ®è®°å½•ä¸­)</span>';
        nextTrial();
    }

    function nextTrial() {
        const total = state.phase === 'practice' ? config.practice : config.formal;
        if(state.current >= total) {
            if(state.phase === 'practice') {
                alert("ç»ƒä¹ ç»“æŸï¼Œç‚¹å‡»ç¡®å®šå¼€å§‹æ­£å¼è¯„ä¼°ï¼");
                startPhase('formal');
            } else {
                showFinish();
            }
            return;
        }
        
        state.current++;
        document.getElementById('progress').innerText = `è¿›åº¦: ${state.current} / ${total}`;
        
        const targetWordKey = colors[Math.floor(Math.random()*4)];
        const targetColorKey = colors[Math.floor(Math.random()*4)];
        
        const el = document.getElementById('word');
        el.innerText = names[targetWordKey];
        el.style.color = targetColorKey;
        
        // å­˜å‚¨å½“å‰è½®æ¬¡çš„æ•°æ®ï¼Œç”¨äºåç»­åˆ¤æ–­ä¸€è‡´æ€§
        state.currentTrialData = {
            word: names[targetWordKey],
            displayColor: targetColorKey,
            isCongruent: (targetWordKey === targetColorKey) // è¯ä¹‰ä¸é¢œè‰²æ˜¯å¦ä¸€è‡´
        };
        
        state.startTime = performance.now();
    }

    function handleInput(selected) {
        const rt = (performance.now() - state.startTime).toFixed(2);
        const isCorrect = (selected === state.currentTrialData.displayColor);
        
        if(state.phase === 'formal') {
            state.results.push({
                ...state.subject,
                trial: state.current,
                word: state.currentTrialData.word,
                displayColor: state.currentTrialData.displayColor,
                isCongruent: state.currentTrialData.isCongruent ? 1 : 0, // 1ä¸ºä¸€è‡´ï¼Œ0ä¸ºä¸ä¸€è‡´
                response: selected,
                isCorrect: isCorrect ? 1 : 0,
                rt: rt
            });
        }
        nextTrial();
    }

    function showFinish() {
        document.getElementById('step-test').classList.add('hidden');
        document.getElementById('step-finish').classList.remove('hidden');
        generateReport(); // ç”ŸæˆæŠ¥å‘Š
    }

    function generateReport() {
        const formalResults = state.results.filter(r => r.isCorrect === 1); // åªè®¡ç®—æ­£ç¡®ååº”

        const totalCorrect = formalResults.length;
        const totalFormalTrials = config.formal;
        const accuracy = (totalCorrect / totalFormalTrials * 100).toFixed(1) + '%';

        const sumRT = formalResults.reduce((sum, r) => sum + parseFloat(r.rt), 0);
        const avgRT = totalCorrect > 0 ? (sumRT / totalCorrect).toFixed(0) + ' ms' : 'N/A';

        // è®¡ç®— Stroop å¹²æ‰°å€¼
        const congruentRTs = formalResults.filter(r => r.isCongruent === 1).map(r => parseFloat(r.rt));
        const incongruentRTs = formalResults.filter(r => r.isCongruent === 0).map(r => parseFloat(r.rt));

        const avgCongruentRT = congruentRTs.length > 0 ? (congruentRTs.reduce((sum, rt) => sum + rt, 0) / congruentRTs.length).toFixed(0) : 0;
        const avgIncongruentRT = incongruentRTs.length > 0 ? (incongruentRTs.reduce((sum, rt) => sum + rt, 0) / incongruentRTs.length).toFixed(0) : 0;
        
        const stroopInterference = (avgIncongruentRT - avgCongruentRT).toFixed(0);

        document.getElementById('avg-rt').innerText = avgRT;
        document.getElementById('stroop-interference').innerText = `${stroopInterference} ms`;
        document.getElementById('accuracy').innerText = accuracy;

        // è§£é‡Šè§£è¯»
        let interpretationText = "";
        if (stroopInterference > 100) {
            interpretationText = "æ‚¨çš„Stroopå¹²æ‰°å€¼è¾ƒé«˜ï¼Œå¯èƒ½åœ¨ä¿¡æ¯å¤„ç†æ—¶å®¹æ˜“å—åˆ°å¹²æ‰°ã€‚è¿™è¡¨æ˜æ‚¨çš„è®¤çŸ¥æ§åˆ¶èƒ½åŠ›æœ‰æå‡ç©ºé—´ï¼Œå»ºè®®è¿›è¡Œæ›´å¤šä¸“æ³¨åŠ›è®­ç»ƒã€‚";
        } else if (stroopInterference > 50) {
            interpretationText = "æ‚¨çš„Stroopå¹²æ‰°å€¼é€‚ä¸­ï¼Œåœ¨é¢å¯¹å†²çªä¿¡æ¯æ—¶è¡¨ç°å‡ºä¸€èˆ¬çš„æŠ—å¹²æ‰°èƒ½åŠ›ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹èƒ½ä¿æŒä¸“æ³¨ï¼Œä½†åœ¨å¤æ‚ç¯å¢ƒä¸­å¯èƒ½ä»éœ€åŠªåŠ›ã€‚";
        } else if (stroopInterference >= 0) {
             interpretationText = "æ‚¨çš„Stroopå¹²æ‰°å€¼è¾ƒä½ï¼Œæ˜¾ç¤ºå‡ºä¼˜ç§€çš„è®¤çŸ¥æ§åˆ¶å’ŒæŠ—å¹²æ‰°èƒ½åŠ›ã€‚æ‚¨åœ¨å¤„ç†å†²çªä¿¡æ¯æ—¶èƒ½å¤Ÿå¿«é€Ÿå‡†ç¡®åœ°åšå‡ºååº”ï¼Œè¡¨ç°å‡ºé«˜åº¦çš„ä¸“æ³¨åŠ›ã€‚";
        } else { // è´Ÿæ•°ï¼Œç†è®ºä¸Šä¸åº”è¯¥å‡ºç°æˆ–å¾ˆå°‘
             interpretationText = "æ‚¨çš„è¡¨ç°éå¸¸å‡ºè‰²ï¼ŒStroopå¹²æ‰°å€¼æä½ï¼ˆç”šè‡³ä¸ºè´Ÿï¼‰ï¼Œè¿™åœ¨ç»Ÿè®¡ä¸Šè¾ƒä¸ºç½•è§ï¼Œå¯èƒ½è¡¨æ˜æ‚¨å¯¹ä»»åŠ¡çš„é€‚åº”æ€§æé«˜æˆ–ååº”é€Ÿåº¦å¼‚äºå¸¸äººã€‚";
        }

        document.getElementById('interpretation').innerText = interpretationText;

        // ç»˜åˆ¶å›¾è¡¨ (ååº”æ—¶åˆ†å¸ƒ)
        const rtValues = formalResults.map(r => parseFloat(r.rt));
        const histogramData = {}; // ç”¨äºç»Ÿè®¡ä¸åŒRTåŒºé—´çš„æ•°é‡
        const binSize = 50; // æ¯50msä¸€ä¸ªåŒºé—´
        const maxRt = Math.max(...rtValues);

        for (let i = 0; i <= maxRt + binSize; i += binSize) {
            histogramData[i] = 0;
        }
        rtValues.forEach(rt => {
            const bin = Math.floor(rt / binSize) * binSize;
            histogramData[bin]++;
        });

        const chartLabels = Object.keys(histogramData).sort((a,b)=>a-b).map(bin => `${bin}-${parseInt(bin)+binSize}ms`);
        const chartData = Object.keys(histogramData).sort((a,b)=>a-b).map(bin => histogramData[bin]);

        const ctx = document.getElementById('rtChart').getContext('2d');
        if (window.rtChartInstance) { // é”€æ¯æ—§å›¾è¡¨å®ä¾‹
            window.rtChartInstance.destroy();
        }
        window.rtChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'æ­£ç¡®ååº”æ—¶åˆ†å¸ƒ',
                    data: chartData,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'ååº”æ—¶é—´ (ms)' }
                    },
                    y: {
                        title: { display: true, text: 'æ­£ç¡®ååº”æ¬¡æ•°' },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += context.parsed.y + ' æ¬¡'; }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function exportData() {
        let csv = "\uFEFFTimestamp,Gender,Age,Trial,Word,DisplayColor,IsCongruent,Response,IsCorrect,RT_ms\n";
        state.results.forEach(r => {
            csv += `${r.timestamp},${r.gender},${r.age},${r.trial},${r.word},${r.displayColor},${r.isCongruent},${r.response},${r.isCorrect},${r.rt}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Stroop_Report_${state.subject.age}_${state.subject.gender}_${Date.now()}.csv`;
        document.body.appendChild(a); // å¿…é¡»æ·»åŠ åˆ°bodyæ‰èƒ½ç‚¹å‡»
        a.click();
        document.body.removeChild(a);
    }
</script>
</body>
</html>
