<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业认知评估系统 - 箱线图版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot@3.10.0"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; }
        .container { background: var(--card); width: 100%; max-width: 800px; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        #word { font-size: 5rem; font-weight: 800; margin: 2rem 0; min-height: 6rem; display: flex; align-items: center; justify-content: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .color-btn { color: white; padding: 1.2rem; border-radius: 0.8rem; border: none; font-size: 1.1rem; cursor: pointer; }
        .hidden { display: none; }
        .stat-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #eee; }
        .chart-wrapper { margin-top: 30px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eef2f6; height: 450px; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <div id="step-info">
        <h2>认知评估系统 (科研级)</h2>
        <p>本测试将生成反应时分布箱线图</p>
        <button style="background:var(--primary); color:white; padding:15px 30px; border:none; border-radius:8px; cursor:pointer;" onclick="startApp()">开始测试</button>
    </div>

    <div id="step-test" class="hidden">
        <div id="status-tag"></div>
        <div id="progress"></div>
        <div id="word"></div>
        <div class="grid">
            <button class="color-btn" style="background:#ef4444" onclick="record('red')">红</button>
            <button class="color-btn" style="background:#3b82f6" onclick="record('blue')">蓝</button>
            <button class="color-btn" style="background:#22c55e" onclick="record('green')">绿</button>
            <button class="color-btn" style="background:#eab308" onclick="record('yellow')">黄</button>
        </div>
    </div>

    <div id="step-report" class="hidden">
        <h2 style="color:var(--primary)">测评数据深度报告</h2>
        <div class="stat-row"><span>总正确率:</span><b id="res-acc"></b></div>
        <div class="stat-row"><span>Stroop 干扰值:</span><b id="res-stroop"></b></div>

        <div class="chart-wrapper">
            <canvas id="boxChart"></canvas>
        </div>

        <div style="margin-top: 20px; text-align: left; font-size: 0.9rem; color: #666;">
            <p>* <b>箱线图说明：</b>中间横线为中位数，箱体代表 25%-75% 的数据区间，上下触须外的点为离群值。</p>
        </div>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px; width:100%">重新测试</button>
    </div>
</div>

<script>
    const cfg = { practice: 5, formal: 30 };
    const colors = ['red', 'blue', 'green', 'yellow'];
    const names = {red:'红', blue:'蓝', green:'绿', yellow:'黄'};
    let trials = [], current = 0, phase = 'practice', startTime, curWord, curColor;

    function startApp() {
        document.getElementById('step-info').classList.add('hidden');
        document.getElementById('step-test').classList.remove('hidden');
        next();
    }

    function next() {
        const total = phase === 'practice' ? cfg.practice : cfg.formal;
        if(current >= total) {
            if(phase === 'practice') { phase = 'formal'; current = 0; alert("练习结束，开始正式记录"); next(); }
            else { finish(); }
            return;
        }
        current++;
        document.getElementById('progress').innerText = `进度: ${current} / ${total}`;
        document.getElementById('status-tag').innerHTML = phase === 'practice' ? '<span class="badge" style="background:#fef3c7; color:#92400e">练习</span>' : '<span class="badge" style="background:#dcfce7; color:#166534">正式</span>';
        
        curWord = colors[Math.floor(Math.random()*4)];
        curColor = colors[Math.floor(Math.random()*4)];
        const el = document.getElementById('word');
        el.innerText = names[curWord]; el.style.color = curColor;
        startTime = performance.now();
    }

    function record(selected) {
        const rt = performance.now() - startTime;
        if(phase === 'formal') {
            trials.push({
                rt: rt,
                isCorrect: selected === curColor,
                type: curWord === curColor ? '一致' : '不一致'
            });
        }
        next();
    }

    function finish() {
        document.getElementById('step-test').classList.add('hidden');
        document.getElementById('step-report').classList.remove('hidden');

        const corrects = trials.filter(t => t.isCorrect);
        const conData = corrects.filter(t => t.type === '一致').map(t => t.rt);
        const inconData = corrects.filter(t => t.type === '不一致').map(t => t.rt);

        // 更新文字统计
        document.getElementById('res-acc').innerText = (corrects.length / trials.length * 100).toFixed(1) + "%";
        const avgCon = conData.reduce((a,b)=>a+b,0)/conData.length || 0;
        const avgIncon = inconData.reduce((a,b)=>a+b,0)/inconData.length || 0;
        document.getElementById('res-stroop').innerText = (avgIncon - avgCon).toFixed(0) + " ms";

        // 绘制箱线图
        const ctx = document.getElementById('boxChart').getContext('2d');
        new Chart(ctx, {
            type: 'boxplot',
            data: {
                labels: ['一致 (Congruent)', '不一致 (Incongruent)'],
                datasets: [{
                    label: '反应时 (ms)',
                    backgroundColor: ['rgba(34, 197, 94, 0.5)', 'rgba(239, 68, 68, 0.5)'],
                    borderColor: ['#166534', '#991b1b'],
                    borderWidth: 2,
                    outlierColor: '#999',
                    padding: 10,
                    itemRadius: 2,
                    data: [conData, inconData]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: '反应时箱线图统计 (RT Box Plot)', font: { size: 16 } }
                }
            }
        });
    }
</script>
</body>
</html>
